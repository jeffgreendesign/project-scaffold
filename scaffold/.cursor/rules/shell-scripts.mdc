---
description: Shell script conventions and common pitfalls
globs: ["**/*.sh"]
---

# Shell Script Rules

## Critical Rules

- Always start with `set -euo pipefail`
- Quote all `case` patterns containing `#` or `*` — unquoted `#*` is parsed as a comment
  - WRONG: `case "$VAR" in //*|#*|\**) ;; esac`
  - RIGHT: `case "$VAR" in "//"*|"#"*|"*"*) ;; esac`
- Verify syntax with `bash -n <file>` before committing

## Package Manager Handling

- Never hardcode `npm`, `npx`, `pnpm`, or `yarn` in user-facing output
- Use detection variables: `PKG_MANAGER`, `PM_RUN`, `PM_INSTALL`, `PM_EXEC`
- Handle Yarn v1 (Classic) vs v2+ (Berry) — `yarn dlx` does not exist in v1
- When detecting yarn version: `yarn --version 2>/dev/null | grep -q '^1\.'`

## Scaffold Templates

- Shell scripts in `scaffold/` are copied into user projects — they must detect the package manager at runtime (e.g., check for lockfiles) rather than relying on build-time variables
- Non-shell templates (`.md`) cannot detect at runtime — use portable phrasing like "`npm run gates` / `pnpm gates` / `yarn gates`" instead of hardcoding one manager

## Common Mistakes

- Using `read -r` without `/dev/tty` in scripts that may run via `curl | bash`
- Using `find | while read` instead of `find -print0 | while IFS= read -r -d ''`
- Suppressing stderr with `2>/dev/null` on commands that should surface errors
- Using `pip` directly instead of `python -m pip` when virtualenv may not be active
